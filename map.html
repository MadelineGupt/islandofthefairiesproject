<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WebXR Canoe Experience</title>
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-environment-component@1.3.0/dist/aframe-environment-component.min.js"></script>
  <script src="https://cdn.rawgit.com/donmccurdy/aframe-extras/master/dist/aframe-extras.min.js"></script>
  <style>
    body {
      opacity: 0;
      transition: opacity 1.5s ease-in-out;
    }

    #homeOverlayButton {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 9999;
      background-color: #222;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    #homeOverlayButton:hover {
      background-color: #444;
    }
  </style>
</head>
<body>
  <a-scene>
    <!-- Environment -->
    <a-entity environment="preset: contact; skyType: atmosphere; ground: none; dressing: none; horizonColor: #88ccee"></a-entity>

    <!-- Water -->
    <a-entity id="water"
              geometry="primitive: plane; width: 300; height: 300"
              rotation="-90 0 0"
              position="0 0 -3"
              material="color: #3d7d92; src: water-texture.jpg; shader: standard; metalness: 0.2; roughness: 0.3; opacity: 0.85;">
    </a-entity>

    <!-- Camera Rig -->
    <a-entity id="camera-rig" movement-controls="constrainToNavMesh: true">
      <a-entity id="camera" camera position="0 1 0" look-controls>
        <a-cursor color="black"></a-cursor>
      </a-entity>
    </a-entity>

    <!-- Styled Button: Take me to Mackinac Island -->
    <a-entity id="nextButton" position="0 10 -3" class="clickable"
              animation="property: position.y; from: 10; to: 10.2; dur: 1000; dir: alternate; loop: true; easing: easeInOutSine"
              animation__hover="property: scale; from: 1 1 1; to: 1.1 1.1 1.1; startEvents: mouseenter; dur: 200"
              animation__leave="property: scale; to: 1 1 1; startEvents: mouseleave; dur: 200">
      <a-plane width="4" height=".7"
               color="#607d99"
               opacity="0.9"
               position="0 0 0"
               material="shader: flat; transparent: true">
      </a-plane>
      <a-plane width="6.3" height="1.5"
               color="#88ccee"
               opacity="0.25"
               position="0 0 -0.01"
               material="shader: flat; transparent: true">
      </a-plane>
      <a-text value="Take me to Mackinac Island"
              align="center"
              color="#ffffff"
              width="5"
              position="0 0 0.02">
      </a-text>
    </a-entity>

    <!-- Map -->
    <a-image id="map" src="map.png"
             position="0 0.1 -3"
             rotation="-90 0 0"
             width="30" height="24"
             material="shader: standard; metalness: 0.1; roughness: 0.8;"
             animation="property: position.y; from: 0.1; to: 0.2; dur: 3000; dir: alternate; loop: true; easing: easeInOutSine;">
    </a-image>

    <!-- Flowers container -->
    <a-entity id="flowers-container"></a-entity>
  </a-scene>

  <!-- HTML Overlay Home Button -->
  <button id="homeOverlayButton">â¬… Home</button>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      document.body.style.opacity = "1";

      const cameraRig = document.querySelector("#camera-rig");
      const nextButton = document.querySelector("#nextButton");

      const urlParams = new URLSearchParams(window.location.search);
      const shouldStartDescended = urlParams.get("descended") === "true";

      if (shouldStartDescended) {
        cameraRig.setAttribute("position", "5 0 -4");
        nextButton.setAttribute("visible", "false");
      } else {
        cameraRig.setAttribute("position", "0 8 10");
        nextButton.setAttribute("visible", "true");
      }

      nextButton.addEventListener("click", function () {
        cameraRig.setAttribute("animation", {
          property: "position",
          to: "5 0 -4",
          dur: 2000,
          easing: "easeOutQuad"
        });
        nextButton.setAttribute("visible", "false");
      });

      // Flower data
      const positions = [
        [5.55, -6.25], [5.5, -4.75], [5.1, -5.25], [5, -5], [5.5, -5.25],
        [5.75, -8], [5.2, -5.5], [5.3, -6.35], [5.4, -6.3], [5.5, -5.7],
        [4.8, -5.7], [4.9, -5.25], [5.1, -5.75], [4.2, -5.75], [5.85, -5.25]
      ];
      const colors = ["#ee888d", "#d72a2a", "#fca311", "#ff66cc", "#9c27b0", "#2196f3", "#4caf50"];
      const container = document.querySelector("#flowers-container");

      positions.forEach((pos, i) => {
        const id = `flower${i + 1}`;
        const seen = localStorage.getItem(id) === "true";
        const scale = seen ? "1 1 1" : "0.01 0.01 0.01";
        const color = colors[i % colors.length];

        const flower = document.createElement("a-entity");
        flower.setAttribute("id", id);
        flower.setAttribute("class", "clickable");
        flower.setAttribute("position", `${pos[0]} 0 ${pos[1]}`);
        flower.setAttribute("scale", scale);

        flower.innerHTML = `
          <a-cylinder position="0 0.15 0" radius="0.02" height="0.3" color="#3b7d3b"></a-cylinder>
          <a-sphere position="0 0.35 0.05" radius="0.05" color="${color}"></a-sphere>
          <a-sphere position="0 0.35 -0.05" radius="0.05" color="${color}"></a-sphere>
          <a-sphere position="0.05 0.35 0" radius="0.05" color="${color}"></a-sphere>
          <a-sphere position="-0.05 0.35 0" radius="0.05" color="${color}"></a-sphere>
          <a-sphere position="0 0.35 0" radius="0.025" color="#ffd700"></a-sphere>
        `;

        flower.addEventListener("click", () => {
          if (!seen) {
            flower.setAttribute("animation__bloom", {
              property: "scale",
              to: "1 1 1",
              dur: 800,
              easing: "easeOutElastic"
            });
            localStorage.setItem(id, "true");
            setTimeout(() => {
              goToVideo(`https://storage.googleapis.com/islandofthefairies/video${i + 1}.mov`);
            }, 900);
          } else {
            goToVideo(`https://storage.googleapis.com/islandofthefairies/video${i + 1}.mov`);
          }
        });

        container.appendChild(flower);
      });

      document.querySelector("#homeOverlayButton").addEventListener("click", function () {
        window.location.href = "index.html";
      });

      AFRAME.registerComponent("paddle-movement", {
        init: function () {
          const rig = document.querySelector("#camera-rig");
          window.addEventListener("keydown", function (event) {
            if (event.key === "w" || event.key === "s") {
              let direction = event.key === "w" ? -1 : 1;
              let currentPosition = rig.getAttribute("position");
              rig.setAttribute("animation", {
                property: "position.z",
                to: currentPosition.z + direction * 2,
                dur: 1500,
                easing: "easeOutQuad"
              });
            }
          });
        }
      });

      document.querySelector("#camera-rig").setAttribute("paddle-movement", "");
    });

    function goToVideo(videoSrc) {
      window.location.href = "video.html?video=" + encodeURIComponent(videoSrc);
    }
  </script>
</body>
</html>
